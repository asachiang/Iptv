name: Auto Update IPTV List

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Run update script
        run: python update_iptv.py

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add *.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update: $(date)" && git push)
                if any(k.lower() in temp_info.lower() for k in keywords):
                    organized[cat].append(f"{temp_info}\n{line}")
                    assigned = True
                    break
            if not assigned:
                organized["其它"].append(f"{temp_info}\n{line}")
            temp_info = "" # 清除快取以便處理下一組

    # 儲存檔案
    for cat, items in organized.items():
        with open(f"{cat}.m3u", "w", encoding="utf-8") as f:
            f.write(f"{header}\n" + "\n".join(items))
    
    with open("all.m3u", "w", encoding="utf-8") as f:
        f.write(f"{header}\n")
        for items in organized.values():
            if items: f.write("\n".join(items) + "\n")

if __name__ == "__main__":
    parse_and_save()
